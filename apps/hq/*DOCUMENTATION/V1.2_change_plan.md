# V1.2 Change Plan: DigiDoc Architecture Alignment

**Version:** 1.2  
**Date:** 2025-12-19  
**Purpose:** Document changes needed to align current codebase with MASTER_ARCHITECTURE.md

---

## 1. Queue Abstraction Layer

### 1.1 Queue Adapter System
- **Purpose**: Create abstraction layer for RQ (MVP) and Celery (production) switching
- **New Directory**: `ocr_service/queue/`
- **New Files**:
  - `ocr_service/queue/__init__.py` - Public API with `enqueue_ocr_task()` function
  - `ocr_service/queue/queue_adapter.py` - Abstract base class `QueueAdapter` and factory function `get_queue_adapter()`
  - `ocr_service/queue/rq_adapter.py` - RQ implementation (MVP)
  - `ocr_service/queue/celery_adapter.py` - Celery implementation (post-MVP)
- **Details**:
  - Abstract interface with `enqueue()`, `enqueue_delayed()`, `get_task_status()` methods
  - Factory function reads `QUEUE_ADAPTER` environment variable
  - `TaskResult` class for unified task result objects

### 1.2 Queue-Agnostic Task Functions
- **Purpose**: Create pure Python task functions that work with any queue adapter
- **New Directory**: `ocr_service/tasks/`
- **New Files**:
  - `ocr_service/tasks/__init__.py`
  - `ocr_service/tasks/receipt_tasks.py` - Task functions: `process_receipt_task()`, `preprocess_image_task()`, `extract_fields_task()`
- **Details**:
  - All task functions must be pure Python with no queue-specific code
  - Functions accept standard parameters (file_path, queue_item_id, calling_app_id)

### 1.3 Dependencies Update
- **File**: `requirements_ocr.txt`
- **Purpose**: Add RQ and Redis dependencies for MVP
- **Details**:
  - Add `rq>=1.0.0`
  - Add `redis>=5.0.0`
  - Add `celery>=5.3.0` (post-MVP, commented for now)

---

## 2. Streamlit GUI System

### 2.1 Streamlit Application Structure
- **Purpose**: Create web-based GUI for review queue and visual inspection
- **New Directory**: `ocr_service/gui/`
- **New Files**:
  - `ocr_service/gui/__init__.py`
  - `ocr_service/gui/app.py` - Main Streamlit application entry point
  - `ocr_service/gui/pages/queue_dashboard.py` - Queue list view with filtering/sorting
  - `ocr_service/gui/pages/preprocessing_review.py` - Side-by-side original vs preprocessed image viewer
  - `ocr_service/gui/pages/template_matching.py` - Template match visualization with keypoint overlays
  - `ocr_service/gui/pages/extraction_review.py` - Extracted fields editor with contour overlays
  - `ocr_service/gui/pages/tiered_suggestions.py` - Non-match handling interface with action list
  - `ocr_service/gui/utils/image_utils.py` - Image loading and display utilities
  - `ocr_service/gui/utils/visualization.py` - Visualization helpers (overlays, keypoint matches, etc.)
- **Details**:
  - All GUI elements web-based using Streamlit
  - No authentication for MVP (provisions for future JWT integration)
  - GUI stack independent from OCR Python logic

### 2.2 Dependencies Update
- **File**: `requirements_ocr.txt`
- **Purpose**: Add Streamlit dependency
- **Details**:
  - Add `streamlit>=1.28.0`

---

## 3. Configuration Management System

### 3.1 Configuration File System
- **Purpose**: Replace hardcoded thresholds and parameters with configurable values
- **New File**: `ocr_service/config.py` - Configuration loader and manager
- **New File**: `digidoc_config.yaml` (or `.json`, `.toml`) - Configuration file in DigiDoc root
- **Details**:
  - Configuration sections: thresholds, scoring weights, preprocessing, file paths, API endpoints, queue, database, LLM
  - Environment variable override support (e.g., `DIGIDOC_AUTO_MATCH_THRESHOLD`)
  - Configuration validation on load

### 3.2 Hardcoded Values Removal
- **File**: `ocr_service/confidence_scorer.py`
- **Purpose**: Remove hardcoded thresholds, load from config
- **Details**:
  - Remove `HIGH_THRESHOLD = 0.85`, `MEDIUM_THRESHOLD = 0.70`, `LOW_THRESHOLD = 0.0`
  - Remove hardcoded weights dictionary
  - Load all values from configuration system

- **File**: `ocr_service/api_server.py`
- **Purpose**: Remove hardcoded confidence thresholds
- **Details**:
  - Replace `>= 0.95` and `>= 0.90` thresholds with config values
  - Replace `>= 0.80` threshold with config value

- **File**: `ocr_service/templates/template_matcher.py`
- **Purpose**: Remove hardcoded confidence threshold
- **Details**:
  - Replace `>= 0.80` threshold with config value

- **File**: `ocr_service/formats/mead_clark_format1.py`
- **Purpose**: Remove hardcoded threshold values
- **Details**:
  - Replace threshold values (0.5, 0.6) with config values

---

## 4. Enhanced Preprocessing Pipeline

### 4.1 Preprocessing Module Restructure
- **Purpose**: Split preprocessing into separate modules per step
- **New Directory**: `ocr_service/preprocessing/`
- **New Files**:
  - `ocr_service/preprocessing/__init__.py`
  - `ocr_service/preprocessing/deskew.py` - Deskew implementation using HoughLinesP
  - `ocr_service/preprocessing/denoise.py` - Denoise using fastNlMeansDenoising
  - `ocr_service/preprocessing/binarize.py` - Binarization with adaptive threshold (Otsu/Gaussian)
  - `ocr_service/preprocessing/normalize.py` - Scale normalization to 300 DPI with cubic interpolation
  - `ocr_service/preprocessing/border_removal.py` - Border removal using contour analysis
- **Details**:
  - Each preprocessing step as separate module
  - Configurable parameters (denoise level, binarization method, target DPI)

### 4.2 Preprocessing Enhancements
- **File**: `ocr_service/utils/image_preprocessing.py`
- **Purpose**: Enhance existing preprocessing with missing steps
- **Details**:
  - Add binarization step (currently missing)
  - Add scale normalization to 300 DPI (currently only resizes for performance)
  - Add border removal step (currently missing)
  - Add color logo processing (HSV color space extraction before binarization)
  - Add handwriting detection (contour irregularity analysis)
  - Generate comparison images (original vs preprocessed side-by-side)

### 4.3 Preprocessing Output Storage
- **Purpose**: Save preprocessed images and comparison images for GUI
- **Details**:
  - Save preprocessed image to `{queue_item_id}/preprocessed.png`
  - Generate and save comparison image to `{queue_item_id}/comparison.png`
  - Store preprocessing metadata (skew angle, DPI, denoise level, etc.)

---

## 5. Three-Tier Template Matching System

### 5.1 Structural Fingerprint Matching
- **Purpose**: Implement image-first, DPI/scale invariant structural matching
- **New Directory**: `ocr_service/matching/`
- **New Files**:
  - `ocr_service/matching/__init__.py`
  - `ocr_service/matching/structural.py` - Structural fingerprint computation and matching
- **Details**:
  - Detect contours using OpenCV findContours
  - Extract zones (header, tables, footer, logos) as bounding boxes
  - Compute structural hash using position + size ratios
  - Compare to stored template fingerprints using Euclidean distance or SSIM
  - Weight: 70% of final match score

### 5.2 Feature Detection Matching
- **Purpose**: Implement ORB keypoint matching for logos
- **New File**: `ocr_service/matching/feature.py` - ORB feature extraction and FLANN matching
- **Details**:
  - Extract ORB features from logo regions
  - Match to template logos using FLANN matcher
  - Calculate match ratio
  - Weight: 20% of final match score
  - Generate visualization (keypoint match lines) for GUI

### 5.3 Text Fallback Matching
- **Purpose**: Implement text-based matching when layout fails
- **New File**: `ocr_service/matching/text_fallback.py` - Text pattern matching
- **Details**:
  - OCR header section
  - Search for vendor name/patterns
  - Calculate text match score
  - Weight: 10% of final match score
  - Highlight matched text in image preview for GUI

### 5.4 Template Matcher Enhancement
- **File**: `ocr_service/templates/template_matcher.py`
- **Purpose**: Integrate three-tier matching approach
- **Details**:
  - Replace text-only matching with three-tier system
  - Implement weighted score calculation: `(0.7 × structural) + (0.2 × feature) + (0.1 × text)`
  - Add configurable thresholds for auto-match (>0.85), partial match (0.60-0.85), no match (<0.60)
  - Add template drift mitigation (auto-variant addition on partial match)

### 5.5 Template Storage Enhancement
- **File**: `ocr_service/database/models.py`
- **Purpose**: Add fields for structural fingerprints and logo features
- **Details**:
  - Add `structural_fingerprint` JSON column to `CachedTemplate`
  - Add `logo_features` binary column to `CachedTemplate`
  - Add variant flag and similarity percentage fields

---

## 6. Enhanced Extraction Pipeline

### 6.1 Zonal OCR Extraction
- **Purpose**: Implement zone-based field extraction using template zones
- **New Directory**: `ocr_service/extraction/`
- **New Files**:
  - `ocr_service/extraction/__init__.py`
  - `ocr_service/extraction/zonal_ocr.py` - Zone-based OCR extraction
- **Details**:
  - Load matched template zones
  - Extract zones (header, tables, footer)
  - Run OCR on each zone individually
  - Map text to fields using template field mappings

### 6.2 Contour-Based Extraction
- **Purpose**: Implement table detection and extraction using contours
- **New File**: `ocr_service/extraction/contour_extraction.py` - Contour-based table extraction
- **Details**:
  - Detect table rows/columns using OpenCV contours
  - Extract text within bounding boxes
  - Support PaddleOCR table engine (optional dependency)
  - Group related fields
  - Generate contour overlay image for GUI

### 6.3 LLM Confirmation Integration
- **Purpose**: Integrate Ollama vision model for handwriting and low-confidence fields
- **New File**: `ocr_service/extraction/llm_confirmation.py` - Ollama LLM integration
- **Details**:
  - Extract zone image
  - Send to Ollama with prompt: "extract total amount from this box image"
  - Parse LLM response
  - Validate against OCR result
  - Cache LLM results in queue item directory

### 6.4 Receipt Extractor Enhancement
- **File**: `ocr_service/extractors/receipt_extractor.py`
- **Purpose**: Integrate new extraction methods
- **Details**:
  - Add zonal OCR extraction step
  - Add contour-based extraction for line items
  - Add LLM confirmation step (when OCR confidence <70%)
  - Add handwriting detection and routing to LLM

### 6.5 Dependencies Update
- **File**: `requirements_ocr.txt`
- **Purpose**: Add LLM and optional PaddleOCR dependencies
- **Details**:
  - Add `ollama>=0.1.0` (or appropriate Ollama Python client)
  - Add `paddleocr>=2.7.0` (optional, for table extraction)

---

## 7. File Storage Architecture

### 7.1 Queue Item Directory Structure
- **Purpose**: Organize all files by queue item ID for crash recovery
- **New File**: `ocr_service/utils/file_utils.py` - File organization utilities
- **Details**:
  - Create directory structure: `{storage_base}/queue/{queue_item_id}/`
  - Store original file: `{queue_item_id}/original.{ext}`
  - Store preprocessed image: `{queue_item_id}/preprocessed.png`
  - Store comparison image: `{queue_item_id}/comparison.png`
  - Store template match visualization: `{queue_item_id}/template_match.png`
  - Store extraction overlay: `{queue_item_id}/extraction_overlay.png`
  - Store extracted fields: `{queue_item_id}/extracted_fields.json`
  - Store OCR text: `{queue_item_id}/ocr_text.txt`
  - Store audit log: `{queue_item_id}/audit_log.json`

### 7.2 File Storage Configuration
- **File**: `config/filesystems.php` (Laravel)
- **Purpose**: Update storage paths to support queue item directory structure
- **Details**:
  - Add configurable storage base path
  - Add queue directory path configuration

### 7.3 Archive File Naming
- **Purpose**: Rename and move processed files with vendor/date/total format
- **Details**:
  - Format: `{vendor}_{YYYYMMDD}_{total}.{ext}`
  - Move to `processed/` directory
  - Update file path references

### 7.4 Receipt Queue Model Update
- **File**: `app/Models/ReceiptQueue.php`
- **Purpose**: Add fields for queue item directory path
- **Details**:
  - Add `queue_item_directory` field (or derive from queue_item_id)

---

## 8. Audit Logging System

### 8.1 Audit Log Implementation
- **Purpose**: Log every processing step for crash recovery and debugging
- **New File**: `ocr_service/utils/audit_logger.py` - Audit logging utilities
- **Details**:
  - Log step name, success/failure, confidence scores, timestamps
  - Store in `{queue_item_id}/audit_log.json`
  - Support crash recovery (resume from last completed step)

### 8.2 Crash Recovery System
- **Purpose**: Resume processing from queue item directory on restart
- **Details**:
  - Scan queue directories on startup
  - Read audit log to determine last completed step
  - Resume processing from that point
  - Handle failed steps appropriately

---

## 9. Status Flow Enhancement

### 9.1 Queue Status Updates
- **File**: `database/migrations/2025_12_16_000856_create_receipt_queue_table.php`
- **Purpose**: Add missing status values
- **Details**:
  - Add `preprocessing` status
  - Add `matching` status
  - Add `extracting` status
  - Update status enum/comments to reflect new flow: `pending → preprocessing → matching → extracting → review → completed`

### 9.2 Status Update Integration
- **File**: `ocr_service/tasks/receipt_tasks.py`
- **Purpose**: Update queue item status at each workflow step
- **Details**:
  - Update status to `preprocessing` at start
  - Update status to `matching` after preprocessing
  - Update status to `extracting` after matching
  - Update status to `review` or `completed` based on confidence

---

## 10. API Endpoint Changes

### 10.1 Enqueue Endpoint
- **File**: `ocr_service/api_server.py`
- **Purpose**: Add `/api/digidoc/enqueue` endpoint for file watcher integration
- **Details**:
  - Accept file_path, calling_app_id (required), source, metadata
  - Create queue item
  - Enqueue RQ job via queue abstraction layer
  - Return queue_item_id and status

### 10.2 Process Complete Endpoint (Laravel)
- **Purpose**: Create endpoint for DigiDoc to POST results
- **New File**: `app/Http/Controllers/Api/DigiDocProcessCompleteController.php`
- **Details**:
  - Accept queue_item_id, calling_app_id, extracted_fields, confidence, template_matched
  - Update ReceiptQueue status to completed
  - Create PurchaseReceipt if high confidence
  - Make endpoint configurable (default: `/api/digidoc/process-complete`)

### 10.3 API Configuration
- **File**: `config/services.php` (Laravel)
- **Purpose**: Add configurable endpoint for process-complete
- **Details**:
  - Add `digidoc_complete_endpoint` configuration
  - Add `digidoc_template_sync_endpoint` configuration

### 10.4 API Server Updates
- **File**: `ocr_service/api_server.py`
- **Purpose**: Update to use queue abstraction and new workflow
- **Details**:
  - Replace synchronous processing with queue enqueue
  - Update `/process` endpoint to enqueue job instead of processing directly
  - Add status checking endpoint

---

## 11. Workflow Integration

### 11.1 Workflow Orchestration
- **File**: `ocr_service/tasks/receipt_tasks.py`
- **Purpose**: Implement complete workflow pipeline
- **Details**:
  - Preprocessing step (with status update)
  - Template matching step (with status update)
  - Extraction step (with status update)
  - Confidence check
  - Route to review or auto-process
  - Archive file

### 11.2 Laravel Integration Update
- **File**: `app/Services/Ocr/OcrProcessingService.php`
- **Purpose**: Update to work with async queue processing
- **Details**:
  - Remove synchronous HTTP call to Python service
  - Update to check queue item status instead
  - Handle async job completion
  - Update status polling or webhook mechanism

---

## 12. Template Drift Mitigation

### 12.1 Variant Detection
- **File**: `ocr_service/templates/template_matcher.py`
- **Purpose**: Auto-add variant templates on partial match
- **Details**:
  - Detect partial matches (score 0.60-0.85)
  - Auto-add as variant with 80% similarity flag
  - Trigger GUI review for approval

### 12.2 Variant Approval Workflow
- **File**: `ocr_service/gui/pages/template_matching.py`
- **Purpose**: Add variant approval interface
- **Details**:
  - "Approve as new variant" button
  - "Create new template" option
  - Visual comparison view

---

## 13. Risk Mitigation Implementations

### 13.1 Handwriting Detection
- **Purpose**: Detect handwriting and route to LLM
- **Details**:
  - Add contour irregularity analysis in preprocessing
  - Route to Ollama LLM when handwriting detected
  - Add GUI manual entry form for handwriting

### 13.2 Color Logo Processing
- **Purpose**: Process color logos before binarization
- **Details**:
  - Add HSV color space processing
  - Extract logos in color
  - Grayscale rest for text
  - Add GUI color preview

### 13.3 Multi-Page Support
- **Purpose**: Handle multi-page documents
- **Details**:
  - Add PDF page extraction
  - Process page 1 for matching
  - Extract from all pages if match found
  - Add GUI page thumbnail selector

### 13.4 DPI Normalization
- **Purpose**: Handle variable DPI/sizes
- **Details**:
  - Add DPI detection
  - Normalize to 300 DPI using cubic interpolation
  - Use ratios (not absolute pixels) for matching
  - Add GUI DPI display

---

## 14. Tiered Suggestions System

### 14.1 Suggestion Generation
- **Purpose**: Generate actionable suggestions for non-matches
- **Details**:
  - Analyze match failure reason
  - Generate list of suggestions:
    1. Manual entry
    2. New template
    3. Partial match (text only)
    4. Skip and archive
  - Present as list in GUI (not buttons)

### 14.2 Suggestion Processing
- **File**: `ocr_service/gui/pages/tiered_suggestions.py`
- **Purpose**: Handle user selection from suggestion list
- **Details**:
  - Process selected option
  - Route to appropriate workflow
  - Update queue item status accordingly

---

## 15. Database Schema Updates

### 15.1 Template Cache Schema
- **File**: `ocr_service/database/models.py`
- **Purpose**: Add fields for structural fingerprints and logo features
- **Details**:
  - Add `structural_fingerprint` JSON column
  - Add `logo_features` binary/blob column
  - Add `is_variant` boolean column
  - Add `similarity_percentage` decimal column

### 15.2 Queue Item Schema (Laravel)
- **File**: `database/migrations/2025_12_16_000856_create_receipt_queue_table.php`
- **Purpose**: Add fields for new workflow
- **Details**:
  - Add `queue_item_directory` field (or derive from ID)
  - Add `preprocessing_metadata` JSON field
  - Add `matching_metadata` JSON field
  - Add `extraction_metadata` JSON field
  - Add `audit_log_path` field
  - Update status field to include new statuses

---

## 16. Module Restructure

### 16.1 Directory Reorganization
- **Purpose**: Align directory structure with MASTER_ARCHITECTURE.md
- **Details**:
  - Move `ocr_service/utils/image_preprocessing.py` → `ocr_service/preprocessing/` (split into modules)
  - Create `ocr_service/matching/` directory
  - Create `ocr_service/extraction/` directory
  - Create `ocr_service/gui/` directory
  - Create `ocr_service/queue/` directory
  - Create `ocr_service/tasks/` directory
  - Keep `ocr_service/templates/` (already exists)
  - Keep `ocr_service/database/` (already exists)
  - Keep `ocr_service/utils/` for general utilities

### 16.2 Module Imports Update
- **Purpose**: Update all imports after directory reorganization
- **Details**:
  - Update imports in `ocr_service/ocr_processor.py`
  - Update imports in `ocr_service/extractors/receipt_extractor.py`
  - Update imports in `ocr_service/api_server.py`
  - Update all other files that import preprocessing utilities

---

## 17. Configuration-Driven Thresholds

### 17.1 Confidence Scorer Configuration
- **File**: `ocr_service/confidence_scorer.py`
- **Purpose**: Load all thresholds and weights from config
- **Details**:
  - Remove all hardcoded values
  - Load from configuration system
  - Support environment variable overrides

### 17.2 Template Matcher Configuration
- **File**: `ocr_service/templates/template_matcher.py`
- **Purpose**: Load matching thresholds from config
- **Details**:
  - Remove hardcoded `>= 0.80` threshold
  - Load auto-match, partial-match thresholds from config

### 17.3 API Server Configuration
- **File**: `ocr_service/api_server.py`
- **Purpose**: Load decision thresholds from config
- **Details**:
  - Remove hardcoded `>= 0.95`, `>= 0.90`, `>= 0.80` thresholds
  - Load from configuration system

---

## 18. Post-MVP Features (Architecture Only)

### 18.1 Celery Adapter
- **File**: `ocr_service/queue/celery_adapter.py`
- **Purpose**: Implement Celery adapter for production
- **Details**:
  - Implement same interface as RQ adapter
  - Support task chains, groups, chords
  - Add Celery configuration

### 18.2 Authentication Integration
- **Purpose**: Add provisions for JWT authentication
- **Details**:
  - Add API context parameter handling
  - Store user_id, environment in queue item
  - Add JWT validation in Streamlit GUI (post-MVP)

### 18.3 Notifications
- **Purpose**: Add email/Slack notifications for review queue
- **Details**:
  - Add notification service
  - Trigger on low confidence items
  - Configurable notification channels

### 18.4 Queue Throttling
- **Purpose**: Implement queue size limits and throttling
- **Details**:
  - Add max queue size configuration
  - Implement throttling logic
  - Add GUI throttling controls

### 18.5 Retention Policies
- **Purpose**: Automatic cleanup of old files
- **Details**:
  - Configurable retention periods
  - Automatic cleanup jobs
  - Archive strategy

### 18.6 Cloud Mirroring Support
- **Purpose**: Architecture support for cloud mirroring
- **Details**:
  - Template sync between local and cloud
  - Queue synchronization
  - Model file synchronization
  - Docker containerization support

---

## 19. Missing Components

### 19.1 PaddleOCR Integration (Optional)
- **Purpose**: Add PaddleOCR for table extraction
- **Details**:
  - Add PaddleOCR dependency (optional)
  - Integrate table engine for line item extraction
  - Fallback to OpenCV contours if not available

### 19.2 DPI Detection
- **Purpose**: Detect image DPI for normalization
- **Details**:
  - Add DPI detection utility
  - Extract DPI from image metadata
  - Use for normalization calculations

### 19.3 PDF Page Extraction
- **Purpose**: Handle multi-page PDFs
- **Details**:
  - Add PDF page extraction utility
  - Process first page for matching
  - Extract from all pages if match found

---

## 20. File Watcher Integration

### 20.1 Enqueue API Endpoint
- **File**: `ocr_service/api_server.py`
- **Purpose**: Create endpoint for file watcher to call
- **Details**:
  - `POST /api/digidoc/enqueue` endpoint
  - Accept file_path, calling_app_id (required), source, metadata
  - Enqueue job via queue abstraction
  - Return queue_item_id

### 20.2 File Watcher Separation
- **File**: `receipt_watcher.py` (separate service)
- **Purpose**: Ensure 100% silo separation
- **Details**:
  - File watcher remains separate OS-level service
  - Calls DigiDoc API endpoint
  - No direct integration with DigiDoc code

---

## 21. Laravel Integration Updates

### 21.1 Process Complete Endpoint
- **New File**: `app/Http/Controllers/Api/DigiDocProcessCompleteController.php`
- **Purpose**: Receive processing results from DigiDoc
- **Details**:
  - Accept JSON with queue_item_id, extracted_fields, confidence, etc.
  - Update ReceiptQueue status
  - Auto-create PurchaseReceipt if high confidence
  - Make endpoint configurable

### 21.2 Template Sync Endpoints
- **Purpose**: Support template push/pull from DigiDoc
- **Details**:
  - Update existing template sync endpoints
  - Add error handling if calling app cannot store/receive
  - Make endpoints configurable

### 21.3 OcrProcessingService Refactor
- **File**: `app/Services/Ocr/OcrProcessingService.php`
- **Purpose**: Update for async queue processing
- **Details**:
  - Remove synchronous HTTP call
  - Add status polling or webhook handling
  - Update to work with queue-based workflow

---

## 22. Documentation Updates

### 22.1 README Updates
- **File**: `ocr_service/README.md`
- **Purpose**: Update documentation for new architecture
- **Details**:
  - Update workflow description
  - Add queue abstraction documentation
  - Add GUI documentation
  - Update configuration documentation

### 22.2 Setup Guide Updates
- **File**: `OCR_SETUP_GUIDE.md`
- **Purpose**: Update setup instructions
- **Details**:
  - Add Redis setup
  - Add RQ worker setup
  - Add Streamlit GUI setup
  - Add configuration file setup

---

## Summary

This change plan outlines the transformation from the current synchronous HTTP-based OCR service to the async queue-based DigiDoc architecture with:

- **Queue abstraction layer** for RQ/Celery switching
- **Streamlit GUI** for visual review and inspection
- **Configuration management** to replace all hardcoded values
- **Enhanced preprocessing** with all required steps and GUI output
- **Three-tier template matching** (structural, feature, text)
- **Enhanced extraction** (zonal OCR, contours, LLM)
- **File storage by queue item ID** for crash recovery
- **Audit logging** for step tracking
- **Tiered suggestions** for non-match handling
- **Risk mitigations** (handwriting, color logos, multi-page, DPI)

All changes are structured as major sections (new concepts), minor sections (changes to existing), and details (single file changes) as requested.
